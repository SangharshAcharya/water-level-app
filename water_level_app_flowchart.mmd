flowchart TD
    A([ðŸš€ App Start]) --> B

    subgraph SIDEBAR["âš™ï¸ Configuration"]
        B[Atmospheric pressure\nDefault 86 kPa or Upload CSV]
    end

    B --> F[ðŸ“‚ Upload sensor files\n.txt OBS Â· .csv Hobo]
    F --> G{Files uploaded?}
    G -- No --> H([Stop])
    G -- Yes --> I

    subgraph DETECT["ðŸ” Format Detection"]
        I{File type?}
        I -- OBS .txt --> L[Detect firmware\npressure > 50 000 â†’ old Ã·100\nelse new Ã·10]
        I -- Hobo .csv --> M[Auto-detect pressure unit\nkPa / mbar / psi / Pa]
        I -- Unknown --> N[âš ï¸ Skip]
    end

    subgraph SETTINGS["ðŸ“ Sensor Settings"]
        O[Map SN â†’ Station name] --> P[Set sensor height / offset\nper file or batch]
    end

    L --> O
    M --> O

    P --> U

    subgraph PROCESS["â–¶ Processing"]
        U[Process All Files] --> W{Format?}
        W -- OBS --> X[Parse â†’ Trim edge outliers\nâ†’ calc_water_level_obs\nhydroP_mbar + h_sensor]
        W -- Hobo --> Y[Parse â†’ Unit conversion\nâ†’ calc_water_level_hobo\nHydro_kPa Ã· 9.80665 + h_sensor]
        X --> Z[Merge baro Â· attach Station & SN]
        Y --> Z
    end

    Z --> BB

    subgraph RESULTS["ðŸ“Š Results"]
        BB[Date-range filter\nOverview metrics & chart] --> BH[Per-station tabs\nWL chart Â· sub-panels Â· data preview]
        BH --> BO[Downloads per station\nCSV & Excel]
    end

    BO --> CP

    subgraph COMBINED["ðŸ’¾ Downloads & Comparison"]
        CP[Combined downloads\nAll stations] --> CQ[ðŸ”€ Comparison Explorer]
        CQ -- Multi-station --> CS[Overlay chart by station]
        CQ -- Multi-period --> CT[Overlay chart by period]
    end

    CS --> CU([â„¹ï¸ About & Formulas])
    CT --> CU

    style A fill:#1a73e8,color:#fff
    style H fill:#f44336,color:#fff
    style N fill:#f44336,color:#fff
    style CU fill:#34a853,color:#fff
    style SIDEBAR fill:#e8f4fd,stroke:#1a73e8
    style DETECT fill:#fff8e1,stroke:#f9a825
    style SETTINGS fill:#fce4ec,stroke:#e91e63
    style PROCESS fill:#e8f5e9,stroke:#388e3c
    style RESULTS fill:#f3e5f5,stroke:#7b1fa2
    style COMBINED fill:#e0f2f1,stroke:#00897b
